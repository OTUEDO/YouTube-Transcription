import os
import openai
import yt_dlp
import ffmpeg

# Set up your OpenAI API key from environment variables
openai.api_key = os.getenv('OPENAI_API_KEY')

def download_audio_from_youtube(youtube_url, output_path="audio.mp3"):
    # Download the YouTube video and extract audio using yt-dlp
    ydl_opts = {
        'format': 'bestaudio/best',
        'outtmpl': 'temp_audio.%(ext)s',
    }
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        ydl.download([youtube_url])
    
    return "temp_audio.webm"

def convert_audio_to_smaller_size(input_path, output_path="smaller_audio.mp3"):
    # Convert the audio to a smaller size using ffmpeg by lowering the bitrate
    ffmpeg.input(input_path).output(output_path, audio_bitrate='64k').run()
    return output_path

def transcribe_audio_with_whisper(file_path):
    # Convert audio to text using Whisper API
    with open(file_path, "rb") as audio_file:
        response = openai.Audio.transcribe("whisper-1", audio_file)
    return response['text']

def youtube_to_text(youtube_url):
    # Step 1: Download audio from YouTube
    audio_path = download_audio_from_youtube(youtube_url)

    # Step 2: Convert the downloaded audio to a smaller size
    smaller_audio_path = convert_audio_to_smaller_size(audio_path)

    # Step 3: Transcribe the audio using Whisper API
    transcription = transcribe_audio_with_whisper(smaller_audio_path)

    # Clean up the audio files
    os.remove(audio_path)
    os.remove(smaller_audio_path)

    return transcription

if __name__ == "__main__":
    youtube_url = input("Enter YouTube video URL: ")
    transcription_text = youtube_to_text(youtube_url)
    print("Transcription:\n")
    print(transcription_text)

'''
Key Changes:
Added convert_audio_to_smaller_size function: This function uses ffmpeg to convert the downloaded audio into a smaller format by lowering the bitrate to 64kbps.
Updated the youtube_to_text function: After downloading the audio, it now converts the file size before sending it to the Whisper API to avoid exceeding the size limit.
Requirements:
Make sure ffmpeg is installed on your system for the audio conversion step to work. You can download it from here.
'''
